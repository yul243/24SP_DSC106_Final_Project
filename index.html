<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>US Choropleth Map</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #map {
            width: 800px;
            height: 600px;
            margin: auto;
        }
    </style>
</head>
<body>
    <h1>Choropleth Map: US States</h1>
    <div id="map"></div>
    <script>
        // Dimensions and projection
        var width = 960, height = 600;
        var projection = d3.geoAlbersUsa()
            .scale(1000)
            .translate([width / 2, height / 2]);

        var path = d3.geoPath()
            .projection(projection);

        // Create SVG element
        var svg = d3.select("#map").append("svg")
            .attr("width", width)
            .attr("height", height);

        // Load data
        d3.csv("table.csv").then(function(data) {
            var dataById = {};
            data.forEach(function(d) {
                dataById[d.fips] = +d['2012'];
            });

            // Load TopoJSON
            d3.json("USA.json").then(function(us) {
                var states = topojson.feature(us, us.objects.states).features;

                // Color scale
                var color = d3.scaleQuantize()
                    .domain([0, d3.max(data, function(d) { return +d['2012']; })])
                    .range(d3.schemeBlues[9]);

                // Draw the map
                svg.selectAll("path")
                    .data(states)
                    .enter().append("path")
                    .attr("d", path)
                    .attr("fill", function(d) {
                        return color(dataById[d.id]);
                    })
                    .attr("stroke", "#fff")
                    .attr("stroke-width", "1");
                
                // Add legend
                var legend = svg.append("g")
                    .attr("id", "legend");

                var legendColors = d3.schemeBlues[9];
                var legendWidth = 20;
                var legendHeight = 20;

                legend.selectAll("rect")
                    .data(legendColors)
                    .enter().append("rect")
                    .attr("x", function(d, i) { return i * legendWidth; })
                    .attr("y", height - legendHeight - 10)
                    .attr("width", legendWidth)
                    .attr("height", legendHeight)
                    .attr("fill", function(d) { return d; });

                var legendScale = d3.scaleLinear()
                    .domain([0, d3.max(data, function(d) { return +d['2012']; })])
                    .range([0, legendColors.length * legendWidth]);

                var legendAxis = d3.axisBottom(legendScale)
                    .ticks(5)
                    .tickSize(13)
                    .tickValues(color.domain());

                legend.append("g")
                    .attr("transform", "translate(0," + (height - legendHeight - 10) + ")")
                    .call(legendAxis)
                    .select(".domain")
                    .remove();
            });
        });
    </script>
</body>
</html>
